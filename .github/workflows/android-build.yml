name: Production-Grade Android APK Pipeline

# Workflow Trigger: Push and PR to main, APK only on push
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # =============================================================================
  # VERIFICATION GATES - All must pass before APK build
  # =============================================================================
  verification-gates:
    name: Verification Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # ========================================
    # GATE 1: Dependency Integrity
    # ========================================
    - name: 'Gate 1: Dependency Integrity - npm ci'
      run: |
        echo "=== GATE 1: Dependency Integrity ==="
        npm ci
        echo "✓ Dependencies installed successfully with lockfile integrity"

    # ========================================
    # GATE 2: Static Quality - Linting
    # ========================================
    - name: 'Gate 2: Static Quality - TypeScript Linting'
      run: |
        echo "=== GATE 2: Static Quality - Linting ==="
        npm run lint
        echo "✓ Lint checks passed"

    # ========================================
    # GATE 3: Unit & Component Tests
    # ========================================
    - name: 'Gate 3: Unit & Component Tests'
      run: |
        echo "=== GATE 3: Unit & Component Tests ==="
        npm test -- --run --reporter=verbose
        echo "✓ All tests passed"

    # ========================================
    # GATE 4: Build Verification
    # ========================================
    - name: 'Gate 4: Build Verification'
      run: |
        echo "=== GATE 4: Build Verification ==="
        npm run build
        echo "✓ Production build completed successfully"

  # =============================================================================
  # SECURITY GATE - CodeQL Analysis
  # =============================================================================
  security-gate:
    name: Security Gate - CodeQL
    runs-on: ubuntu-latest
    needs: verification-gates
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript-typescript

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: 'Gate 5: Security Analysis - CodeQL'
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript-typescript"

  # =============================================================================
  # ANDROID APK BUILD - Only on push to main, only after all gates pass
  # =============================================================================
  build-signed-apk:
    name: Build Signed APK
    runs-on: ubuntu-latest
    # CRITICAL: Only run on push to main, and only after ALL gates pass
    needs: [verification-gates, security-gate]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # ========================================
    # CI GUARD: Prevent signing regressions
    # ========================================
    - name: CI Guard - Validate workflow integrity
      run: |
        echo "=== CI Guard: Workflow Integrity Checks ==="
        
        # Check for masked placeholders
        if grep -q '\*\*\*\*\*\*' .github/workflows/android-build.yml; then
          echo "❌ ERROR: Masked signing placeholder detected"
          exit 1
        fi
        
        # Check for SHA-256 signing references
        if grep -iE 'sha-?256.*sign' .github/workflows/android-build.yml; then
          echo "❌ ERROR: SHA-256 signing detected - keystore-only signing required"
          exit 1
        fi
        
        echo "✓ CI Guard checks passed"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    # Rebuild application (dependencies already verified by gates)
    - name: Install dependencies
      run: npm ci

    - name: Build web application
      run: npm run build

    # ========================================
    # Android Build Environment
    # ========================================
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Sync Capacitor
      run: npx cap sync android

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    # ========================================
    # SIGNING CONFIGURATION
    # DO NOT MODIFY WITHOUT SECURITY REVIEW
    # ========================================
    - name: Validate signing secrets
      run: |
        echo "=== Signing Secrets Validation ==="
        if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ] || \
           [ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ] || \
           [ -z "${{ secrets.ANDROID_KEY_ALIAS }}" ] || \
           [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ]; then
          echo "❌ ERROR: Signing secrets are required for main branch builds"
          echo ""
          echo "Required GitHub Secrets:"
          echo "  - ANDROID_KEYSTORE_BASE64"
          echo "  - ANDROID_KEYSTORE_PASSWORD"
          echo "  - ANDROID_KEY_ALIAS"
          echo "  - ANDROID_KEY_PASSWORD"
          echo ""
          echo "See SIGNING_SETUP.md for configuration instructions."
          exit 1
        fi
        echo "✓ All signing secrets configured"
    
    - name: Decode signing keystore
      run: |
        echo "=== Decoding Keystore ==="
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
        echo "✓ Keystore decoded successfully"

    - name: Build signed release APK
      working-directory: ./android
      env:
        KEYSTORE_FILE: app/keystore.jks
        KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        REQUIRE_SIGNED_RELEASE: "true"
      run: |
        echo "=== Building Signed Release APK ==="
        ./gradlew assembleRelease \
          -Pandroid.injected.signing.store.file=app/keystore.jks \
          -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
          -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
          -Pandroid.injected.signing.key.password=$KEY_PASSWORD
        echo "✓ APK build completed"

    # ========================================
    # SIGNATURE VERIFICATION (CRITICAL)
    # ========================================
    - name: Verify APK cryptographic signature
      run: |
        echo "=== APK Signature Verification ==="
        APKSIGNER=$(find $ANDROID_HOME/build-tools -name apksigner | sort -V | tail -n 1)
        
        if [ -z "$APKSIGNER" ]; then
          echo "❌ apksigner not found in Android SDK"
          exit 1
        fi
        
        if $APKSIGNER verify --print-certs android/app/build/outputs/apk/release/app-release.apk; then
          echo ""
          echo "✓ APK signature verified successfully"
          echo "✓ APK is cryptographically signed and ready for distribution"
        else
          echo ""
          echo "❌ APK signature verification FAILED"
          echo "❌ APK is NOT properly signed"
          exit 1
        fi

    - name: Verify APK file exists
      run: |
        if [ ! -f "android/app/build/outputs/apk/release/app-release.apk" ]; then
          echo "❌ ERROR: Release APK not found"
          exit 1
        fi
        echo "✓ Release APK exists"

    # ========================================
    # Build Metadata
    # ========================================
    - name: Generate build metadata
      id: build-meta
      run: |
        echo "=== Build Metadata ==="
        APP_NAME="verum-omnis"
        COMMIT_SHA="${{ github.sha }}"
        SHORT_SHA="${COMMIT_SHA:0:7}"
        TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
        
        echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT
        echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "artifact_name=${APP_NAME}-${SHORT_SHA}-${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        echo "Application: ${APP_NAME}"
        echo "Commit SHA: ${SHORT_SHA}"
        echo "Timestamp: ${TIMESTAMP}"

    - name: Print build information
      working-directory: ./android
      run: |
        echo "=== Android Build Information ==="
        echo "Application ID: $(grep 'applicationId' app/build.gradle | awk '{print $2}' | tr -d '"')"
        echo "Version Name: $(grep 'versionName' app/build.gradle | awk '{print $2}' | tr -d '"')"
        echo "Version Code: $(grep 'versionCode' app/build.gradle | awk '{print $2}')"
        ls -lh app/build/outputs/apk/release/
        echo "================================="

    # ========================================
    # Upload Verified APK
    # ========================================
    - name: Upload signed APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build-meta.outputs.artifact_name }}
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}-${{ steps.build-meta.outputs.short_sha }}
        name: Release ${{ steps.build-meta.outputs.artifact_name }}
        body: |
          ## Verified Production APK
          
          **Build Information:**
          - Commit: ${{ github.sha }}
          - Build Time: ${{ steps.build-meta.outputs.timestamp }}
          - Run ID: ${{ github.run_id }}
          
          **Verification Status:**
          ✅ All verification gates passed
          ✅ Security analysis passed (CodeQL)
          ✅ APK cryptographically signed
          
          This APK is cryptographic proof that the entire system passed all verification gates.
        files: android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
